<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avemar Production Tracking - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'outfit': ['Outfit', 'sans-serif'] },
          colors: {
            'avemar': {
              'navy': '#0a1628', 'slate': '#1e293b', 'steel': '#334155',
              'sky': '#0ea5e9', 'gold': '#f59e0b', 'emerald': '#10b981',
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Outfit', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #0a1628 0%, #1e293b 50%, #0f172a 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
    .stat-card { background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(255, 255, 255, 0.1); }
    .stage-card { background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(255, 255, 255, 0.1); min-width: 160px; }
    .stage-card.has-late { border-color: rgba(239, 68, 68, 0.5); }
    .stage-card.has-units { border-color: rgba(14, 165, 233, 0.3); }
    select { background-color: #1e293b; color: #f1f5f9; }
    select option { background-color: #1e293b; color: #f1f5f9; }
    select option:checked { background-color: #334155; }
  </style>
</head>
<body class="gradient-bg min-h-screen text-white">

  <!-- Navigation -->
  <nav class="bg-avemar-navy/80 backdrop-blur-lg border-b border-white/10 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-avemar-gold to-orange-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-industry text-white text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">Avemar Group</h1>
            <p class="text-xs text-gray-400">Production Tracking</p>
          </div>
        </div>
        <div class="flex items-center gap-6">
          <a href="index.html" class="text-avemar-gold font-medium"><i class="fas fa-chart-line mr-2"></i>Dashboard</a>
          <a href="repair-orders.html" class="text-gray-300 hover:text-white transition"><i class="fas fa-clipboard-list mr-2"></i>Repair Orders</a>
          <a href="inventory.html" class="text-gray-300 hover:text-white transition"><i class="fas fa-boxes-stacked mr-2"></i>Inventory</a>
          <a href="bom.html" class="text-gray-300 hover:text-white transition"><i class="fas fa-list-check mr-2"></i>BOM</a>
          <a href="settings.html" class="text-gray-300 hover:text-white transition"><i class="fas fa-cog mr-2"></i>Settings</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-8">

    <!-- Connection Status -->
    <div id="connectionStatus" class="mb-4 text-center">
      <span class="text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Connecting to database...</span>
    </div>

    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h2 class="text-3xl font-bold mb-2">Production Dashboard</h2>
        <p class="text-gray-400">Windshield repair tracking overview</p>
      </div>
      <a href="new-repair-order.html" class="bg-avemar-gold hover:bg-amber-600 text-black px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2">
        <i class="fas fa-plus"></i> New Repair Order
      </a>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="stat-card rounded-2xl p-6 card-hover cursor-pointer" onclick="window.location.href='repair-orders.html?status=In Progress'">
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-avemar-sky/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-cogs text-avemar-sky text-xl"></i>
          </div>
        </div>
        <h3 class="text-4xl font-bold mb-1" id="activeCount">--</h3>
        <p class="text-gray-400 text-sm">Active Orders</p>
      </div>

      <div class="stat-card rounded-2xl p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
          </div>
        </div>
        <h3 class="text-4xl font-bold mb-1 text-red-400" id="lateCount">--</h3>
        <p class="text-gray-400 text-sm">Late Units</p>
      </div>

      <div class="stat-card rounded-2xl p-6 card-hover cursor-pointer" onclick="window.location.href='repair-orders.html?status=On Hold'">
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-avemar-gold/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-pause-circle text-avemar-gold text-xl"></i>
          </div>
        </div>
        <h3 class="text-4xl font-bold mb-1" id="holdCount">--</h3>
        <p class="text-gray-400 text-sm">On Hold</p>
      </div>

      <div class="stat-card rounded-2xl p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-avemar-emerald/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-check-circle text-avemar-emerald text-xl"></i>
          </div>
        </div>
        <h3 class="text-4xl font-bold mb-1" id="completedMonthCount">--</h3>
        <p class="text-gray-400 text-sm">Completed This Month</p>
      </div>

      <div class="stat-card rounded-2xl p-6 card-hover cursor-pointer" onclick="window.location.href='inventory.html?filter=low'">
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-box-open text-orange-400 text-xl"></i>
          </div>
        </div>
        <h3 class="text-4xl font-bold mb-1" id="lowStockCount">--</h3>
        <p class="text-gray-400 text-sm">Low Stock Alerts</p>
      </div>
    </div>

    <!-- Production Stage Pipeline -->
    <div class="stat-card rounded-2xl p-6 mb-8">
      <h3 class="text-xl font-semibold mb-6"><i class="fas fa-stream text-avemar-gold mr-2"></i>Production Pipeline</h3>
      <div class="flex gap-4 overflow-x-auto pb-4" id="stagePipeline">
        <div class="text-gray-400 text-center py-12 w-full"><i class="fas fa-spinner fa-spin mr-2"></i>Loading production stages...</div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Recent Repair Orders -->
      <div class="lg:col-span-2 stat-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold"><i class="fas fa-clock text-avemar-sky mr-2"></i>Recent Repair Orders</h3>
          <a href="repair-orders.html" class="text-avemar-sky text-sm hover:underline">View All</a>
        </div>
        <div class="space-y-3" id="recentOrders">
          <div class="text-gray-400 text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>
        </div>
      </div>

      <!-- Low Stock Alerts -->
      <div class="stat-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold"><i class="fas fa-exclamation-circle text-orange-400 mr-2"></i>Low Stock Alerts</h3>
          <a href="inventory.html" class="text-avemar-sky text-sm hover:underline">View Inventory</a>
        </div>
        <div class="space-y-3" id="lowStockAlerts">
          <div class="text-gray-400 text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/10 mt-12 py-6">
    <div class="max-w-7xl mx-auto px-6 text-center text-gray-500 text-sm">
      <p>&copy; 2026 Avemar Group. Production Tracking System. <span class="text-emerald-400"><i class="fas fa-cloud mr-1"></i>Cloud Connected</span></p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="js/auth.js"></script>

  <script>
    async function loadDashboard() {
      try {
        const stats = await db.getDashboardStats();

        document.getElementById('connectionStatus').innerHTML =
          '<span class="text-emerald-400"><i class="fas fa-check-circle mr-2"></i>Connected to cloud database</span>';

        document.getElementById('activeCount').textContent = stats.totalActive;
        document.getElementById('lateCount').textContent = stats.stages.reduce((sum, s) => sum + s.lateCount, 0);
        document.getElementById('holdCount').textContent = stats.totalOnHold;
        document.getElementById('completedMonthCount').textContent = stats.completedThisMonth;
        document.getElementById('lowStockCount').textContent = stats.lowStockCount;

        renderStagePipeline(stats.stages);
        renderRecentOrders(stats);
        renderLowStockAlerts(stats.lowStockItems);
      } catch (error) {
        console.error('Dashboard load error:', error);
        document.getElementById('connectionStatus').innerHTML =
          '<span class="text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>Database connection error</span>';
      }
    }

    function renderStagePipeline(stages) {
      const container = document.getElementById('stagePipeline');

      if (!stages || stages.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center py-12 w-full">No production stages configured. <a href="settings.html" class="text-avemar-sky hover:underline">Set up stages</a></div>';
        return;
      }

      container.innerHTML = stages.map((stage, idx) => {
        let borderClass = '';
        if (stage.lateCount > 0) borderClass = 'has-late';
        else if (stage.unitCount > 0) borderClass = 'has-units';

        return `
          <div class="stage-card ${borderClass} rounded-xl p-4 flex-shrink-0 cursor-pointer card-hover"
               onclick="window.location.href='repair-orders.html?stage=${stage.stageNumber}'">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs text-gray-500 font-medium">STAGE ${stage.stageNumber}</span>
              ${stage.lateCount > 0 ? '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>' : ''}
            </div>
            <h4 class="text-sm font-semibold text-white mb-3 leading-tight">${stage.stageName}</h4>
            <div class="text-3xl font-bold ${stage.unitCount > 0 ? 'text-avemar-sky' : 'text-gray-600'}">${stage.unitCount}</div>
            <p class="text-xs text-gray-500 mt-1">
              ${stage.lateCount > 0 ? `<span class="text-red-400">${stage.lateCount} late</span>` : 'units'}
            </p>
            ${idx < stages.length - 1 ? '' : ''}
          </div>
        `;
      }).join('<div class="flex items-center flex-shrink-0 text-gray-600"><i class="fas fa-chevron-right"></i></div>');
    }

    function renderRecentOrders(stats) {
      const container = document.getElementById('recentOrders');
      const orders = stats.stages.flatMap(s => s.units).slice(0, 8);

      if (orders.length === 0) {
        container.innerHTML = `
          <div class="text-gray-400 text-center py-8">
            No active repair orders.
            <a href="new-repair-order.html" class="text-avemar-gold hover:underline ml-1">Create your first order</a>
          </div>`;
        return;
      }

      const stageNames = {};
      stats.stages.forEach(s => stageNames[s.stageNumber] = s.stageName);

      container.innerHTML = orders.map(order => {
        const statusColors = {
          'In Progress': 'bg-avemar-sky/20 text-avemar-sky',
          'Completed': 'bg-emerald-500/20 text-emerald-400',
          'On Hold': 'bg-avemar-gold/20 text-avemar-gold',
          'Cancelled': 'bg-red-500/20 text-red-400'
        };
        const statusClass = statusColors[order.status] || 'bg-gray-500/20 text-gray-400';

        return `
          <div class="flex items-center gap-4 p-4 bg-white/5 rounded-xl hover:bg-white/10 transition cursor-pointer"
               onclick="window.location.href='repair-order-detail.html?id=${order.id}'">
            <div class="flex-1">
              <div class="flex items-center gap-3">
                <h4 class="font-medium text-white">${order.roNumber}</h4>
                <span class="px-2 py-0.5 rounded-full text-xs ${statusClass}">${order.status}</span>
              </div>
              <p class="text-sm text-gray-400">${order.customerName} &bull; ${order.partNumber} &bull; S/N: ${order.serialNumber}</p>
            </div>
            <div class="text-right">
              <span class="text-xs text-gray-500">Stage ${order.currentStage}</span>
              <p class="text-sm text-gray-300">${stageNames[order.currentStage] || ''}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderLowStockAlerts(items) {
      const container = document.getElementById('lowStockAlerts');

      if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-emerald-400 text-center py-8"><i class="fas fa-check-circle mr-2"></i>All stock levels OK</div>';
        return;
      }

      container.innerHTML = items.map(item => {
        const pct = Number(item.reorderPoint) > 0 ? (Number(item.quantityOnHand) / Number(item.reorderPoint)) * 100 : 0;
        const urgent = pct <= 50;

        return `
          <div class="flex items-center gap-3 p-3 bg-white/5 rounded-xl">
            <div class="w-10 h-10 ${urgent ? 'bg-red-500/20' : 'bg-yellow-500/20'} rounded-lg flex items-center justify-center flex-shrink-0">
              <i class="fas fa-box-open ${urgent ? 'text-red-400' : 'text-yellow-400'}"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-medium text-white text-sm truncate">${item.partNumber}</h4>
              <p class="text-xs text-gray-400">${item.quantityOnHand} ${item.unitOfMeasure} left &bull; Lead: ${item.leadTimeDays}d</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // Realtime updates
    function setupRealtime() {
      db.subscribeToRepairOrders(() => loadDashboard());
      db.subscribeToSubcomponents(() => loadDashboard());
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeAuth();
      await loadDashboard();
      setupRealtime();
    });
  </script>
</body>
</html>
